package com.zhqydot.framework.easyrouter.compiler;

import com.google.auto.service.AutoService;

import java.io.IOException;
import java.io.Writer;
import java.util.HashMap;
import java.util.LinkedHashSet;
import java.util.Map;
import java.util.Set;

import javax.annotation.processing.AbstractProcessor;
import javax.annotation.processing.Filer;
import javax.annotation.processing.ProcessingEnvironment;
import javax.annotation.processing.Processor;
import javax.annotation.processing.RoundEnvironment;
import javax.lang.model.SourceVersion;
import javax.lang.model.element.Element;
import javax.lang.model.element.TypeElement;
import javax.tools.JavaFileObject;

@AutoService(Processor.class)
public class RouterProcessor extends AbstractProcessor {

    private Filer mFiler;
    @Override public synchronized void init(ProcessingEnvironment processingEnvironment) {
        super.init(processingEnvironment);
        mFiler = processingEnvironment.getFiler();
    }

    @Override
    public boolean process(Set<? extends TypeElement> set, RoundEnvironment roundEnvironment) {
        Set<? extends Element> routerElements = roundEnvironment.getElementsAnnotatedWith(Router.class);
        Map<String, String> routeMap = new HashMap<>();
        for (Element element : routerElements) {
            routeMap.put(element.getAnnotation(Router.class).path(), ((TypeElement) element).getQualifiedName().toString());
        }
        createFile(routeMap);
        return true;
    }

    @Override
    public SourceVersion getSupportedSourceVersion() {
        return SourceVersion.RELEASE_8;
    }

    @Override public Set<String> getSupportedAnnotationTypes() {
        Set<String> annotations = new LinkedHashSet<>();
        annotations.add(Router.class.getCanonicalName());
        return annotations;
    }

    private void createFile(Map<String, String> routeMap) {
        try {
            JavaFileObject jfo = mFiler.createSourceFile("com.zhqydot.framework.easyrouter.core.RouterLoader", new Element[]{});
            Writer writer = jfo.openWriter();
            writer.write(brewCode(routeMap));
            writer.flush();
            writer.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private String brewCode(Map<String, String> routeMap) {
        StringBuilder builder = new StringBuilder();
        builder.append("package com.zhqydot.framework.easyrouter.core;\n\n");
        appendComment(builder);
        builder.append("import com.zhqydot.framework.easyrouter.core.RouterManager;\n\n");
        builder.append("public class RouterLoader { \n\n");
        builder.append("\tpublic void load() { \n");
        for (Map.Entry<String, String> entry : routeMap.entrySet()) {
            builder.append("\t\ttry {\n");
            String reg = String.format("RouterManager.register(\"%s\", Class.forName(\"%s\"));", entry.getKey(), entry.getValue());
            builder.append("\t\t\t").append(reg).append("\n");
            builder.append("\t\t} catch(ClassNotFoundException e) {\n");
            builder.append("\t\t\te.printStackTrace();\n");
            builder.append("\t\t}\n");
        }
        builder.append("\t}\n");
        builder.append("}");
        return builder.toString();
    }

    private void appendComment(StringBuilder builder) {
        builder.append("\n/**\n");
        builder.append(" * This class was generated by EasyRouter\n");
        builder.append(" * do not modify it\n");
        builder.append(" * or it will cause EasyRouter run with exception\n");
        builder.append(" */\n\n");
    }
}